/*! async-csrf-forms - v1.0.0 - 2013-08-04
 * https://github.com/dherges/async-csrf-forms
 * Copyright (c) 2013 David Herges
 * Licensed MIT, Apache-2.0
 */!function(a,b){var c=a.ender||a.jQuery||b,d=a.ender&&require?require("reqwest").compat:c.ajax;if(c===b)throw"$ is undefined. xcsrf depends on either ender or jQuery.";var e={url:"",header:"x-csrf-token",cookie:"x-csrf-token",field:"x-csrf-token"},f=function(a,b){this.init(a,b)};f.prototype.init=function(a,d){this.$node=c(a),this.options={},this.options.url=d&&d.url||this.$node.attr("data-x-csrf-url")||e.url,this.options.cookie=d&&d.cookie||this.$node.attr("data-x-csrf-cookie")||e.cookie,this.options.field=d&&d.field||this.$node.attr("data-x-csrf-field")||e.field,this.options.header=d&&d.header||this.$node.attr("data-x-csrf-header")||e.header,this.options.intention=b;var f=this.readCookie(this.options.intention);this.options.cookie&&f?this.appendField(f):this.listen(),this.$node.data("xcsrf",this)},f.prototype.readCookie=function(a){var d=a?b:{raw:!0},e=c.cookie(this.options.cookie,null,d);return e?e[a]:e},f.prototype.storeCookie=function(a,b){var d=a,e={path:"/"};b?(d={},d[b]=""+a,c.cookie.json=!0):e.raw=!0,c.cookie(this.options.cookie,d,e)},f.prototype.listen=function(){var a=this;this.$node.one("focusin submit",function(b){b.preventDefault(),a.unlisten(),a.requestToken(function(c){a.onTokenReceived(c),b&&"submit"===b.type&&a.submitForm()})})},f.prototype.unlisten=function(){this.$node.off("focusin submit")},f.prototype.requestToken=function(a){var b=this;d({url:this.options.url,xhrFields:{withCredentials:!0},success:function(c,d,e){c&&c.getResponseHeader&&(e=c),a&&a(e.getResponseHeader(b.options.header))}})},f.prototype.onTokenReceived=function(a){this.options.cookie&&"false"!==this.options.cookie&&this.storeCookie(a,this.options.intention),this.appendField(a)},f.prototype.appendField=function(a){this.$node.append('<input type="hidden" name="'+this.options.field+'" value="'+a+'">')},f.prototype.submitForm=function(){var a=this;window.setTimeout(function(){a.$node.get(0).submit()},200)},a.ender&&provide?provide("xcsrf",f):a.jQuery&&(a.jQuery.fn.xcsrf=function(a){return this.each(function(){new f(this,a)})})}(this);